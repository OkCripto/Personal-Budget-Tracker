<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Budget Tracker</title>
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Custom Google Font: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js for visualizations (needed for the provided JS) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom styles and animations */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light gray-blue background */
            transition: background-color 0.3s ease;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out, background-color 0.3s ease;
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .btn-primary {
            background-color: #4f46e5; /* Indigo-600 */
            color: white;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #4338ca; /* Indigo-700 */
        }
        .btn-secondary {
            background-color: #e5e7eb; /* Gray-200 */
            color: #374151; /* Gray-700 */
            transition: background-color 0.2s;
        }
        .btn-secondary:hover {
            background-color: #d1d5db; /* Gray-300 */
        }
        .btn-danger {
            background-color: #ef4444; /* Red-500 */
            color: white;
            transition: background-color 0.2s;
        }
        .btn-danger:hover {
            background-color: #dc2626; /* Red-600 */
        }
        .tab-active {
            border-bottom: 3px solid #4f46e5;
            color: #4f46e5;
            font-weight: 600;
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease-out;
        }
        .modal-content {
            animation: slideInUp 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideInUp {
            from { transform: translateY(30px) scale(0.95); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }
        /* Custom scrollbar for transaction list */
        .transaction-list::-webkit-scrollbar {
            width: 8px;
        }
        .transaction-list::-webkit-scrollbar-track {
            background: #f1f5f9; /* Slate-100 */
        }
        .transaction-list::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* Slate-300 */
            border-radius: 4px;
        }
        .transaction-list::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; /* Slate-400 */
        }

        /* --- UI Polish --- */
        /* Smooth transitions for form elements */
        input, select, textarea, .type-toggle-btn {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
        /* Smoother focus state for inputs and dropdowns */
        input:focus, select:focus, textarea:focus {
            border-color: #4f46e5; /* Indigo-600 */
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
            outline: none;
        }
        /* Glow effect for inactive type button on hover */
        .type-toggle-btn:hover:not(.bg-indigo-600) {
            transform: translateY(-2px);
            box-shadow: 0 0 0 2px #c7d2fe; /* Indigo-200 ring */
        }
        /* Hover effect for transaction items */
        .transaction-item:hover {
            transform: translateX(4px);
            background-color: #f8fafc; /* Slate-50 */
        }
        .category-item, .asset-item {
            transition: background-color 0.2s ease-in-out;
        }
        .note-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out, margin-top 0.3s ease-in-out, padding-top 0.3s ease-in-out;
        }
        .note-content.visible {
             max-height: 100px; /* Adjust as needed */
             margin-top: 0.5rem;
             padding-top: 0.5rem;
        }
        .note-toggle-btn.rotated svg {
            transform: rotate(180deg);
        }
        #expense-chart-container, #expense-trend-chart-container, #asset-chart-container {
            position: relative;
            width: 100%;
            height: 20rem; /* h-80 */
        }
        #expense-chart, #expense-trend-chart, #asset-chart {
            cursor: pointer;
        }
        #chart-tooltip {
            position: fixed;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            transform: translate(-50%, calc(-100% - 10px));
            white-space: nowrap;
            z-index: 100;
        }
        .color-swatch {
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 9999px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .color-swatch.selected {
            border-color: #4f46e5;
            transform: scale(1.2);
        }
    </style>
</head>
<body class="antialiased">

    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- App Header and Navigation -->
        <header class="mb-8">
            <div class="flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0">
                <div class="flex items-center">
                    <h1 class="text-3xl font-bold text-slate-800 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-3 text-indigo-600" viewBox="0 0 20 20" fill="currentColor"><path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4z" /><path fill-rule="evenodd" d="M18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z" clip-rule="evenodd" /></svg>
                        Budget Tracker
                    </h1>
                    <button id="visibility-toggle" class="ml-4 p-2 rounded-full text-slate-500 hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <svg id="eye-icon-open" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                          <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                        <svg id="eye-icon-slashed" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.477 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243l-4.243-4.243zM11.828 15c-.623.623-1.478 1-2.428 1-1.933 0-3.5-1.567-3.5-3.5 0-.95.377-1.805 1-2.428M14.122 14.122L12 12" />
                          <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c1.206 0 2.362.248 3.44.686M21 12c-1.274 4.057-5.064 7-9.542 7A9.97 9.97 0 015.025 15.025" />
                          <path stroke-linecap="round" stroke-linejoin="round" d="M3 3l18 18" />
                        </svg>
                    </button>
                </div>
                <nav class="flex space-x-2 p-1 bg-slate-200 rounded-lg">
                    <button id="nav-tracker" class="px-4 py-2 text-sm font-medium rounded-md transition-colors tab-active">Tracker</button>
                    <button id="nav-assets" class="px-4 py-2 text-sm font-medium rounded-md text-slate-600 transition-colors">Assets</button>
                    <button id="nav-all-transactions" class="px-4 py-2 text-sm font-medium rounded-md text-slate-600 transition-colors">All Transactions</button>
                    <button id="nav-analytics" class="px-4 py-2 text-sm font-medium rounded-md text-slate-600 transition-colors">Analytics</button>
                </nav>
            </div>
        </header>

        <!-- Main Content Area -->
        <main>
            <!-- Tracker Page -->
            <div id="page-tracker">
                <!-- Summary Cards -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="card p-6 flex justify-between items-center">
                        <div>
                            <p class="text-sm font-medium text-slate-500">Monthly Income</p>
                            <p id="income-amount" class="text-3xl font-bold text-green-600">₹0.00</p>
                        </div>
                         <div class="p-3 bg-green-100 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01" /></svg>
                        </div>
                    </div>
                    <div class="card p-6 flex justify-between items-center">
                        <div>
                            <p class="text-sm font-medium text-slate-500">Monthly Expense</p>
                            <p id="expense-amount" class="text-3xl font-bold text-red-600">₹0.00</p>
                        </div>
                        <div class="p-3 bg-red-100 rounded-full">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6" /></svg>
                        </div>
                    </div>
                    <div class="card p-6 flex justify-between items-center">
                        <div>
                            <p class="text-sm font-medium text-slate-500">Monthly Savings</p>
                            <p id="monthly-savings-amount" class="text-3xl font-bold text-purple-600">₹0.00</p>
                        </div>
                        <div class="p-3 bg-purple-100 rounded-full">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                        </div>
                    </div>
                    <div class="card p-6 flex justify-between items-center">
                        <div>
                            <p class="text-sm font-medium text-slate-500">Net Worth</p>
                            <p id="net-worth-amount" class="text-3xl font-bold text-blue-600">₹0.00</p>
                        </div>
                        <div class="p-3 bg-blue-100 rounded-full">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>
                        </div>
                    </div>
                </div>

                <!-- Add Transaction and Transactions List -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Left Column: Add Transaction Form -->
                    <div class="lg:col-span-1 card p-6">
                        <h2 class="text-xl font-semibold text-slate-800 mb-4">Add Transaction</h2>
                        <form id="transaction-form" class="space-y-4">
                            <input type="hidden" id="transaction-id">
                            <div>
                                <label for="transaction-type" class="block text-sm font-medium text-slate-700">Type</label>
                                <div class="mt-1 flex rounded-md shadow-sm">
                                    <button type="button" id="type-btn-income" class="type-toggle-btn w-1/2 relative inline-flex items-center justify-center px-4 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:z-10 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Income</button>
                                    <button type="button" id="type-btn-expense" class="type-toggle-btn w-1/2 -ml-px relative inline-flex items-center justify-center px-4 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:z-10 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Expense</button>
                                    <input type="hidden" id="transaction-type" value="expense">
                                </div>
                            </div>
                             <div>
                                <label for="transaction-asset" class="block text-sm font-medium text-slate-700">Account / Asset</label>
                                <select id="transaction-asset" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                                    <!-- Assets populated by JS -->
                                </select>
                            </div>
                            <div>
                                <label for="transaction-date" class="block text-sm font-medium text-slate-700">Date</label>
                                <input type="date" id="transaction-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                            </div>
                            <div>
                                <label for="transaction-category" class="block text-sm font-medium text-slate-700">Category</label>
                                <select id="transaction-category" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                                    <!-- Categories populated by JS -->
                                </select>
                            </div>
                            <div>
                                <label for="transaction-amount" class="block text-sm font-medium text-slate-700">Amount</label>
                                <div class="mt-1 relative rounded-md shadow-sm">
                                    <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                                        <span class="text-gray-500 sm:text-sm">₹</span>
                                    </div>
                                    <input type="number" id="transaction-amount" class="block w-full rounded-md border-gray-300 pl-7 pr-2 sm:text-sm" placeholder="0.00" step="0.01">
                                </div>
                            </div>
                            <div>
                                <label for="transaction-description" class="block text-sm font-medium text-slate-700">Description</label>
                                <input type="text" id="transaction-description" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" placeholder="e.g., Groceries">
                            </div>
                            <div>
                                <label for="transaction-note" class="block text-sm font-medium text-slate-700">Note (Optional)</label>
                                <textarea id="transaction-note" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" placeholder="Add any extra details..."></textarea>
                            </div>
                            <div class="flex space-x-2">
                                <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium btn-primary">Save Transaction</button>
                                <button type="button" id="cancel-edit-btn" class="w-full hidden justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium btn-secondary">Cancel Edit</button>
                            </div>
                        </form>
                    </div>

                    <!-- Right Column: Transactions List -->
                    <div class="lg:col-span-2 card p-6">
                        <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4 gap-4">
                            <h2 class="text-xl font-semibold text-slate-800">Recent Transactions</h2>
                             <div class="flex space-x-2">
                                <button id="manage-categories-btn" class="text-sm font-medium text-indigo-600 hover:text-indigo-800 flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0 3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                    Manage Categories
                                </button>
                                <button id="data-options-btn" class="text-sm font-medium text-indigo-600 hover:text-indigo-800 flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor"><path d="M10 3a1 1 0 011 1v1.333a1 1 0 01-.786.973l-1.637.545a1 1 0 01-1.156-1.156l.545-1.637A1 1 0 0110 4.333V3z" /><path d="M10 8a1 1 0 011 1v1.333a1 1 0 01-.786.973l-1.637.545a1 1 0 01-1.156-1.156l.545-1.637A1 1 0 0110 9.333V8z" /><path d="M10 13a1 1 0 011 1v1.333a1 1 0 01-.786.973l-1.637.545a1 1 0 01-1.156-1.156l.545-1.637A1 1 0 0110 14.333V13z" /></svg>
                                    Data Options
                                </button>
                            </div>
                        </div>
                        <div id="transaction-list-container" class="transaction-list h-[450px] overflow-y-auto pr-2">
                            <!-- JS will render transactions here -->
                            <div id="no-transactions-msg" class="text-center py-16">
                                <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                                <h3 class="mt-2 text-sm font-medium text-slate-900">No transactions</h3>
                                <p class="mt-1 text-sm text-slate-500">Get started by adding a new transaction.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Assets Page -->
            <div id="page-assets" class="hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 space-y-8">

                        <!-- Added Total Assets Card -->
                        <div class="card p-6 flex justify-between items-center">
                            <div>
                                <p class="text-sm font-medium text-slate-500">Total Assets</p>
                                <p id="total-assets-amount" class="text-3xl font-bold text-blue-600">₹0.00</p>
                            </div>
                            <div class="p-3 bg-blue-100 rounded-full">
                               <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>
                            </div>
                        </div>
                        <!-- End Added Card -->

                        <div class="card p-6">
                            <h2 class="text-xl font-semibold text-slate-800 mb-4">Transfer Funds</h2>
                            <form id="transfer-form" class="space-y-4">
                                <div>
                                    <label for="transfer-from" class="block text-sm font-medium text-slate-700">From</label>
                                    <select id="transfer-from" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm"></select>
                                </div>
                                <div>
                                    <label for="transfer-to" class="block text-sm font-medium text-slate-700">To</label>
                                    <select id="transfer-to" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm"></select>
                                </div>
                                <div>
                                    <label for="transfer-amount" class="block text-sm font-medium text-slate-700">Amount</label>
                                    <div class="mt-1 relative rounded-md shadow-sm">
                                        <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3"><span class="text-gray-500 sm:text-sm">₹</span></div>
                                        <input type="number" id="transfer-amount" class="block w-full rounded-md border-gray-300 pl-7 pr-2 sm:text-sm" placeholder="0.00" step="0.01">
                                    </div>
                                </div>
                                <button type="submit" class="w-full btn-primary py-2 px-4 rounded-md">Transfer</button>
                            </form>
                        </div>

                         <div class="card p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-semibold text-slate-800">Your Assets</h2>
                                <button id="manage-assets-btn" class="text-sm font-medium text-indigo-600 hover:text-indigo-800">Manage</button>
                            </div>
                            <ul id="asset-list" class="space-y-3">
                                <!-- Asset list rendered by JS -->
                            </ul>
                        </div>
                    </div>
                    <div class="lg:col-span-2 card p-6">
                         <h2 class="text-xl font-semibold text-slate-800 mb-4">Asset Distribution</h2>
                         <div id="asset-chart-container">
                            <canvas id="asset-chart"></canvas>
                             <div id="asset-chart-empty" class="absolute inset-0 flex items-center justify-center text-slate-500 hidden">Add assets to see distribution.</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- All Transactions Page -->
            <div id="page-all-transactions" class="hidden">
                <div class="card p-6">
                    <h2 class="text-2xl font-bold text-slate-800 mb-6">All Transactions</h2>
                    
                    <!-- Filters -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-12 gap-4 mb-6 p-4 bg-slate-50 rounded-lg border">
                        <div class="lg:col-span-3">
                             <label for="search-description" class="block text-sm font-medium text-slate-700">Search</label>
                             <input type="text" id="search-description" placeholder="Search by description..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                        </div>
                        <div class="lg:col-span-2">
                             <label for="filter-type" class="block text-sm font-medium text-slate-700">Type</label>
                             <select id="filter-type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                                 <option value="all">All Types</option>
                                 <option value="income">Income</option>
                                 <option value="expense">Expense</option>
                             </select>
                        </div>
                        <div class="lg:col-span-3">
                             <label for="filter-category" class="block text-sm font-medium text-slate-700">Category</label>
                             <select id="filter-category" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                                 <!-- JS Populated -->
                             </select>
                        </div>
                        <div class="lg:col-span-4 grid grid-cols-2 gap-2">
                            <div>
                                <label for="filter-date-start" class="block text-sm font-medium text-slate-700">From</label>
                                <input type="date" id="filter-date-start" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                            </div>
                            <div>
                                <label for="filter-date-end" class="block text-sm font-medium text-slate-700">To</label>
                                <input type="date" id="filter-date-end" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                            </div>
                        </div>
                        <div class="col-span-full flex items-center justify-end space-x-2 mt-2">
                            <button id="reset-filters-btn" class="h-9 px-4 btn-secondary rounded-md text-sm">Reset Filters</button>
                            <button id="erase-data-btn" class="h-9 px-4 btn-danger rounded-md text-sm">Erase All Data</button>
                        </div>
                    </div>

                    <!-- Full Transaction List -->
                    <div id="full-transaction-list-container" class="transaction-list h-[600px] overflow-y-auto pr-2">
                        <!-- JS renders full list here -->
                    </div>
                </div>
            </div>

            <!-- Analytics Page -->
            <div id="page-analytics" class="hidden">
                <!-- Filters -->
                <div class="card p-4 mb-8 flex flex-col sm:flex-row gap-4 items-center">
                    <h3 class="text-lg font-semibold text-slate-700">Analytics Filters</h3>
                    <div class="flex-grow grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div>
                            <label for="analytics-period" class="block text-sm font-medium text-slate-700">Period</label>
                            <select id="analytics-period" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                                <option value="this-week">This Week</option>
                                <option value="this-month" selected>This Month</option>
                                <option value="this-year">This Year</option>
                                <option value="ytd">Year to Date</option>
                                <option value="all-time">All Time</option>
                            </select>
                        </div>
                         <div>
                            <label for="analytics-year" class="block text-sm font-medium text-slate-700">Year</label>
                            <select id="analytics-year" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                                <!-- JS Populated -->
                            </select>
                        </div>
                        <div>
                            <label for="analytics-month" class="block text-sm font-medium text-slate-700">Month</label>
                            <select id="analytics-month" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                                <!-- JS Populated -->
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Analytics Summary -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                     <div class="card p-6">
                        <p class="text-sm font-medium text-slate-500">Net Savings</p>
                        <p id="analytics-savings" class="text-3xl font-bold text-slate-800">₹0.00</p>
                    </div>
                    <div class="card p-6">
                        <p class="text-sm font-medium text-slate-500">Total Income</p>
                        <p id="analytics-income" class="text-3xl font-bold text-green-600">₹0.00</p>
                    </div>
                    <div class="card p-6">
                        <p class="text-sm font-medium text-slate-500">Total Expenses</p>
                        <p id="analytics-expenses" class="text-3xl font-bold text-red-600">₹0.00</p>
                    </div>
                </div>

                <!-- Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="card p-6">
                        <h3 class="text-xl font-semibold text-slate-800 mb-4">Expense by Category</h3>
                        <div id="expense-chart-container">
                            <canvas id="expense-chart"></canvas>
                             <div id="expense-chart-empty" class="absolute inset-0 flex items-center justify-center text-slate-500 hidden">No expense data for this period.</div>
                        </div>
                    </div>
                    <div class="card p-6">
                        <h3 class="text-xl font-semibold text-slate-800 mb-4">Expense Trend</h3>
                        <div id="expense-trend-chart-container">
                            <canvas id="expense-trend-chart"></canvas>
                            <div id="expense-trend-chart-empty" class="absolute inset-0 flex items-center justify-center text-slate-500 hidden">Not enough data to show a trend.</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <!-- Generic Modal Shell -->
    <div id="modal-container" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden modal-backdrop">
        <div id="modal-content" class="w-full max-w-md bg-white rounded-lg shadow-xl p-6 modal-content">
            <!-- Modal content will be injected here by JS -->
        </div>
    </div>
    
    <!-- Chart Tooltip -->
    <div id="chart-tooltip"></div>


<script>
document.addEventListener('DOMContentLoaded', () => {

    // -------------------------------------------------------------------------
    // STATE MANAGEMENT
    // -------------------------------------------------------------------------
    
    const PREDEFINED_COLORS = ['#ef4444', '#f97316', '#f59e0b', '#10b981', '#14b8a6', '#06b6d4', '#0ea5e9', '#6366f1', '#8b5cf6', '#d946ef'];
    const getRandomColor = () => PREDEFINED_COLORS[Math.floor(Math.random() * PREDEFINED_COLORS.length)];
    
    let state = {
        assets: [
            { id: 'cash-default', name: 'Cash', balance: 0 },
            { id: 'bank-default', name: 'Bank', balance: 0 }
        ],
        transactions: [],
        incomeCategories: ['Salary', 'Freelance', 'Investment'],
        expenseCategories: [
            { name: 'Food', color: PREDEFINED_COLORS[0] },
            { name: 'Transport', color: PREDEFINED_COLORS[1] },
            { name: 'Utilities', color: PREDEFINED_COLORS[2] },
            { name: 'Entertainment', color: PREDEFINED_COLORS[3] },
            { name: 'Health', color: PREDEFINED_COLORS[4] }
        ],
        ui: {
            currentPage: 'tracker', // 'tracker', 'assets', 'all-transactions', or 'analytics'
            formMode: 'add', // 'add' or 'edit'
            editingId: null,
            activeType: 'expense',
            isBalanceVisible: true, 
            filters: {
                description: '',
                type: 'all',
                category: 'all',
                startDate: '',
                endDate: ''
            },
            analytics: {
                period: 'this-month',
                year: new Date().getFullYear(),
                month: new Date().getMonth(),
                hiddenCategories: []
            }
        }
    };
    
    // Load state from localStorage
    const loadState = () => {
        const localState = localStorage.getItem('budgetTrackerState');
        if (localState) {
            const savedState = JSON.parse(localState);
            // Ensure backward compatibility
            if (savedState.expenseCategories && typeof savedState.expenseCategories[0] === 'string') {
                savedState.expenseCategories = savedState.expenseCategories.map((name, index) => ({
                    name: name,
                    color: PREDEFINED_COLORS[index % PREDEFINED_COLORS.length]
                }));
            }
            if (!savedState.assets) { // Add default assets for old users
                savedState.assets = [
                    { id: 'cash-default', name: 'Cash', balance: 0 },
                    { id: 'bank-default', name: 'Bank', balance: 0 }
                ];
            }
            // Deep merge for nested objects like 'ui' and 'analytics'
            if (savedState.ui) {
                 if (savedState.ui.analytics) {
                    savedState.ui.analytics = {...state.ui.analytics, ...savedState.ui.analytics};
                 }
                savedState.ui = {...state.ui, ...savedState.ui};
            }
            state = { ...state, ...savedState };

            if (typeof state.ui.isBalanceVisible === 'undefined') {
                state.ui.isBalanceVisible = true;
            }
        }
    };

    // Save state to localStorage
    const saveState = () => {
        localStorage.setItem('budgetTrackerState', JSON.stringify(state));
    };

    // -------------------------------------------------------------------------
    // DOM ELEMENTS
    // -------------------------------------------------------------------------

    const pageTracker = document.getElementById('page-tracker');
    const pageAssets = document.getElementById('page-assets');
    const pageAllTransactions = document.getElementById('page-all-transactions');
    const pageAnalytics = document.getElementById('page-analytics');
    
    const navTracker = document.getElementById('nav-tracker');
    const navAssets = document.getElementById('nav-assets');
    const navAllTransactions = document.getElementById('nav-all-transactions');
    const navAnalytics = document.getElementById('nav-analytics');
    
    const incomeAmountEl = document.getElementById('income-amount');
    const expenseAmountEl = document.getElementById('expense-amount');
    const netWorthAmountEl = document.getElementById('net-worth-amount');
    const monthlySavingsAmountEl = document.getElementById('monthly-savings-amount');

    const form = document.getElementById('transaction-form');
    const formIdInput = document.getElementById('transaction-id');
    const formTypeInput = document.getElementById('transaction-type');
    const formAssetSelect = document.getElementById('transaction-asset');
    const formDateInput = document.getElementById('transaction-date');
    const formCategorySelect = document.getElementById('transaction-category');
    const formAmountInput = document.getElementById('transaction-amount');
    const formDescriptionInput = document.getElementById('transaction-description');
    const formNoteTextarea = document.getElementById('transaction-note');
    const typeBtnIncome = document.getElementById('type-btn-income');
    const typeBtnExpense = document.getElementById('type-btn-expense');
    const cancelEditBtn = document.getElementById('cancel-edit-btn');
    
    const visibilityToggleBtn = document.getElementById('visibility-toggle');
    const eyeIconOpen = document.getElementById('eye-icon-open');
    const eyeIconSlashed = document.getElementById('eye-icon-slashed');

    const transactionListContainer = document.getElementById('transaction-list-container');
    const noTransactionsMsg = document.getElementById('no-transactions-msg');
    
    // All Transactions Page Elements
    const fullTransactionListContainer = document.getElementById('full-transaction-list-container');
    const searchDescriptionInput = document.getElementById('search-description');
    const filterTypeSelect = document.getElementById('filter-type');
    const filterCategorySelect = document.getElementById('filter-category');
    const filterDateStartInput = document.getElementById('filter-date-start');
    const filterDateEndInput = document.getElementById('filter-date-end');
    const resetFiltersBtn = document.getElementById('reset-filters-btn');
    const eraseDataBtn = document.getElementById('erase-data-btn');

    // Assets Page Elements
    const assetListEl = document.getElementById('asset-list');
    const manageAssetsBtn = document.getElementById('manage-assets-btn');
    const transferForm = document.getElementById('transfer-form');
    const totalAssetsAmountEl = document.getElementById('total-assets-amount'); // <-- Added this
 
    const manageCategoriesBtn = document.getElementById('manage-categories-btn');
    const dataOptionsBtn = document.getElementById('data-options-btn');
    const modalContainer = document.getElementById('modal-container');
    const modalContent = document.getElementById('modal-content');

    // Analytics elements
    const analyticsPeriodSelect = document.getElementById('analytics-period');
    const analyticsYearSelect = document.getElementById('analytics-year');
    const analyticsMonthSelect = document.getElementById('analytics-month');
    const analyticsSavingsEl = document.getElementById('analytics-savings');
    const analyticsIncomeEl = document.getElementById('analytics-income');
    const analyticsExpensesEl = document.getElementById('analytics-expenses');
    const chartTooltip = document.getElementById('chart-tooltip');

    // -------------------------------------------------------------------------
    // UTILITY FUNCTIONS
    // -------------------------------------------------------------------------

    const formatCurrency = (amount) => {
        return new Intl.NumberFormat('en-IN', {
            style: 'currency',
            currency: 'INR',
        }).format(amount);
    };

    const formatDateForInput = (date) => {
        return new Date(date).toISOString().split('T')[0];
    };
    
    const formatDateForDisplay = (date) => {
        // Adjust for timezone offset to display the correct local date
        const d = new Date(date);
        const userTimezoneOffset = d.getTimezoneOffset() * 60000;
        return new Date(d.getTime() + userTimezoneOffset).toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric',
            year: 'numeric'
        });
    };

    // -------------------------------------------------------------------------
    // RENDER FUNCTIONS (Updating the UI)
    // -------------------------------------------------------------------------
    
    const render = () => {
        renderSummary();
        renderTransactionList(state.transactions, transactionListContainer, noTransactionsMsg); // Show all for sorting demo
        renderForm();
        renderPage();
    };
    
    const renderVisibilityToggle = () => {
        const isVisible = state.ui.isBalanceVisible;
        eyeIconOpen.classList.toggle('hidden', !isVisible);
        eyeIconSlashed.classList.toggle('hidden', isVisible);
    };

    const renderSummary = () => {
        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = now.getMonth();
        const isVisible = state.ui.isBalanceVisible;
        const censoredText = '₹ ******';

        // Calculate totals for the current month for the income/expense cards
        const monthlyIncome = state.transactions
            .filter(t => {
                const transactionDate = new Date(t.date);
                return t.type === 'income' && t.category !== 'Internal Transfer' && transactionDate.getFullYear() === currentYear && transactionDate.getMonth() === currentMonth;
            })
            .reduce((sum, t) => sum + t.amount, 0);

        const monthlyExpense = state.transactions
            .filter(t => {
                const transactionDate = new Date(t.date);
                return t.type === 'expense' && t.category !== 'Internal Transfer' && transactionDate.getFullYear() === currentYear && transactionDate.getMonth() === currentMonth;
            })
            .reduce((sum, t) => sum + t.amount, 0);
        
        const monthlySavings = monthlyIncome - monthlyExpense;

        // Calculate Net Worth
        const netWorth = state.assets.reduce((sum, asset) => sum + asset.balance, 0);

        incomeAmountEl.textContent = isVisible ? formatCurrency(monthlyIncome) : censoredText;
        expenseAmountEl.textContent = isVisible ? formatCurrency(monthlyExpense) : censoredText;
        monthlySavingsAmountEl.textContent = isVisible ? formatCurrency(monthlySavings) : censoredText;
        netWorthAmountEl.textContent = isVisible ? formatCurrency(netWorth) : censoredText;
        
        monthlySavingsAmountEl.className = `text-3xl font-bold ${monthlySavings >= 0 ? 'text-purple-600' : 'text-orange-500'}`;
        netWorthAmountEl.className = `text-3xl font-bold ${netWorth >= 0 ? 'text-blue-600' : 'text-orange-500'}`;
        
        renderVisibilityToggle();
    };

    const renderTransactionList = (transactions, container, emptyMsgEl) => {
        container.innerHTML = '';

        if (transactions.length === 0) {
            emptyMsgEl.style.display = 'block';
             if (container.id === 'full-transaction-list-container') {
                emptyMsgEl.innerHTML = `<div class="text-center py-16">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                                        <h3 class="mt-2 text-sm font-medium text-slate-900">No transactions found</h3>
                                        <p class="mt-1 text-sm text-slate-500">Try adjusting your filters or adding a new transaction.</p>
                                    </div>`;
            } else {
                 emptyMsgEl.innerHTML = `<div class="text-center py-16">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                                        <h3 class="mt-2 text-sm font-medium text-slate-900">No recent transactions</h3>
                                        <p class="mt-1 text-sm text-slate-500">Get started by adding a new transaction.</p>
                                    </div>`;
            }
            return;
        }
        
        emptyMsgEl.style.display = 'none';

        const sortedTransactions = [...transactions].sort((a, b) => {
            const dateComparison = new Date(b.date) - new Date(a.date);
            if (dateComparison !== 0) {
                return dateComparison;
            }
            // If dates are the same, sort by creation timestamp, descending
            // Fallback to 0 for transactions without a timestamp (older ones)
            const timeB = b.createdAt ? new Date(b.createdAt).getTime() : 0;
            const timeA = a.createdAt ? new Date(a.createdAt).getTime() : 0;
            return timeB - timeA;
        });

        const transactionsToDisplay = (container.id === 'transaction-list-container') ? sortedTransactions.slice(0, 10) : sortedTransactions;


        transactionsToDisplay.forEach(t => {
            const isIncome = t.type === 'income';
            const sign = isIncome ? '+' : '-';
            const amountClass = isIncome ? 'text-green-600' : 'text-red-600';
            const assetName = state.assets.find(a => a.id === t.assetId)?.name || 'Unknown';

            const li = document.createElement('div');
            li.className = 'transaction-item p-4 border-b border-slate-200 transition-all duration-200';
            li.innerHTML = `
                <div class="flex items-start justify-between w-full flex-wrap">
                    <!-- Main content row -->
                    <div class="flex items-center space-x-4">
                        <div class="p-3 rounded-full ${isIncome ? 'bg-green-100' : 'bg-red-100'}">
                            ${isIncome ? 
                                `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01" /></svg>` :
                                `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6" /></svg>`
                            }
                        </div>
                        <div>
                            <p class="font-semibold text-slate-800">${t.description}</p>
                            <p class="text-sm text-slate-500">${t.category} on ${assetName} &bull; ${formatDateForDisplay(t.date)}</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <p class="font-semibold text-right ${amountClass}">${state.ui.isBalanceVisible ? `${sign}${formatCurrency(Math.abs(t.amount))}`: '******'}</p>
                        ${t.note ? `
                            <button class="note-toggle-btn p-1 text-slate-400 hover:text-indigo-600">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transition-transform duration-200" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                            </button>
                        ` : '<div class="w-7"></div>' /* Placeholder for alignment */}
                        <button data-id="${t.id}" class="edit-btn p-1 text-slate-500 hover:text-indigo-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                        </button>
                        <button data-id="${t.id}" class="delete-btn p-1 text-slate-500 hover:text-red-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>

                    <!-- Note content row -->
                    ${t.note ? `
                        <div class="note-content w-full border-t border-slate-100">
                            <p class="text-sm text-slate-600 whitespace-pre-wrap font-mono pl-16">${t.note}</p>
                        </div>
                    ` : ''}
                </div>
            `;
            container.appendChild(li);
        });
    };

    const renderForm = () => {
        const activeStyles = ['bg-indigo-600', 'text-white', 'border-indigo-600', 'z-10'];
        const inactiveStyles = ['border-gray-300', 'bg-white', 'text-gray-700', 'hover:bg-gray-50'];

        [typeBtnIncome, typeBtnExpense].forEach(btn => btn.classList.remove(...activeStyles, ...inactiveStyles));

        if (state.ui.activeType === 'income') {
            typeBtnIncome.classList.add(...activeStyles);
            typeBtnExpense.classList.add(...inactiveStyles);
        } else {
            typeBtnExpense.classList.add(...activeStyles);
            typeBtnIncome.classList.add(...inactiveStyles);
        }

        formTypeInput.value = state.ui.activeType;
        
        const currentCategory = formCategorySelect.value;
        formCategorySelect.innerHTML = '';
        const categories = state.ui.activeType === 'income' ? state.incomeCategories : state.expenseCategories.map(c => c.name);
        categories.sort().forEach(cat => {
            const option = document.createElement('option');
            option.value = cat;
            option.textContent = cat;
            formCategorySelect.appendChild(option);
        });
        if(categories.includes(currentCategory)) {
            formCategorySelect.value = currentCategory;
        }

        const currentAsset = formAssetSelect.value;
        formAssetSelect.innerHTML = '';
        state.assets.forEach(asset => {
             const option = document.createElement('option');
            option.value = asset.id;
            option.textContent = asset.name;
            formAssetSelect.appendChild(option);
        });
        if(state.assets.find(a => a.id === currentAsset)) {
            formAssetSelect.value = currentAsset;
        }
    };

    const renderPage = () => {
        pageTracker.classList.add('hidden');
        pageAssets.classList.add('hidden');
        pageAllTransactions.classList.add('hidden');
        pageAnalytics.classList.add('hidden');

        // --- START MODIFICATION ---
        const allNavButtons = [navTracker, navAssets, navAllTransactions, navAnalytics];

        // Reset all buttons to inactive state
        allNavButtons.forEach(btn => {
            btn.classList.remove('tab-active');
            btn.classList.add('text-slate-600');
        });

        const setActiveNav = (navEl) => {
            navEl.classList.remove('text-slate-600'); // Remove inactive text color
            navEl.classList.add('tab-active'); // Add active styles
        };
        // --- END MODIFICATION ---

        if (state.ui.currentPage === 'tracker') {
            pageTracker.classList.remove('hidden');
            setActiveNav(navTracker);
        } else if (state.ui.currentPage === 'assets') {
            pageAssets.classList.remove('hidden');
            setActiveNav(navAssets);
             setTimeout(() => {
                const assetChartCanvas = document.getElementById('asset-chart');
                if (assetChartCanvas) {
                    const container = assetChartCanvas.parentElement;
                    if(container && container.clientWidth > 0) {
                        assetChartCanvas.width = container.clientWidth;
                        assetChartCanvas.height = container.clientHeight;
                    }
                    renderAssetsPage();
                }
            }, 0);
        } else if (state.ui.currentPage === 'all-transactions') {
            pageAllTransactions.classList.remove('hidden');
            setActiveNav(navAllTransactions);
            renderAllTransactionsPage();
        } else if (state.ui.currentPage === 'analytics') {
            pageAnalytics.classList.remove('hidden');
            setActiveNav(navAnalytics);
            
            setTimeout(() => {
                renderAnalytics(); 
            }, 0);
        }
    };
    
    // -------------------------------------------------------------------------
    // "ALL TRANSACTIONS" PAGE LOGIC
    // -------------------------------------------------------------------------
    
    const renderFilters = () => {
        // Populate category dropdown
        const allCategories = [...new Set(['Internal Transfer', ...state.incomeCategories, ...state.expenseCategories.map(c => c.name)])];
        filterCategorySelect.innerHTML = '<option value="all">All Categories</option>';
        allCategories.sort().forEach(cat => {
            const option = document.createElement('option');
            option.value = cat;
            option.textContent = cat;
            filterCategorySelect.appendChild(option);
        });

        // Set values from state
        searchDescriptionInput.value = state.ui.filters.description;
        filterTypeSelect.value = state.ui.filters.type;
        filterCategorySelect.value = state.ui.filters.category;
        filterDateStartInput.value = state.ui.filters.startDate;
        filterDateEndInput.value = state.ui.filters.endDate;
    };

    const renderAllTransactionsPage = () => {
        renderFilters();
        
        let filtered = [...state.transactions];
        const { description, type, category, startDate, endDate } = state.ui.filters;

        if (description) {
            filtered = filtered.filter(t => t.description.toLowerCase().includes(description.toLowerCase()));
        }
        if (type !== 'all') {
            filtered = filtered.filter(t => t.type === type);
        }
        if (category !== 'all') {
            filtered = filtered.filter(t => t.category === category);
        }
        if (startDate) {
            filtered = filtered.filter(t => new Date(t.date) >= new Date(startDate));
        }
        if (endDate) {
            const endOfDay = new Date(endDate);
            endOfDay.setHours(23, 59, 59, 999);
            filtered = filtered.filter(t => new Date(t.date) <= endOfDay);
        }
        
        renderTransactionList(filtered, fullTransactionListContainer, document.createElement('div'));
    };
    
    searchDescriptionInput.addEventListener('input', () => {
        state.ui.filters.description = searchDescriptionInput.value;
        renderAllTransactionsPage();
    });

    [filterTypeSelect, filterCategorySelect, filterDateStartInput, filterDateEndInput].forEach(el => {
        el.addEventListener('change', () => {
            state.ui.filters.type = filterTypeSelect.value;
            state.ui.filters.category = filterCategorySelect.value;
            state.ui.filters.startDate = filterDateStartInput.value;
            state.ui.filters.endDate = filterDateEndInput.value;
            renderAllTransactionsPage();
        });
    });
    
    resetFiltersBtn.addEventListener('click', () => {
        state.ui.filters = {
            description: '',
            type: 'all',
            category: 'all',
            startDate: '',
            endDate: ''
        };
        renderAllTransactionsPage();
    });

    eraseDataBtn.addEventListener('click', () => {
        // Use a custom modal instead of confirm()
        const modalHTML = `
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z"></path></svg>
                </div>
                <h3 class="mt-2 text-lg font-semibold text-gray-900">Erase All Data?</h3>
                <p class="mt-2 text-sm text-gray-500">Are you sure you want to erase ALL data, including transactions and categories? This action is permanent and cannot be undone.</p>
                <div class="mt-5 sm:mt-6 flex justify-center space-x-3">
                    <button id="confirm-erase" class="btn-danger w-full rounded-md px-3 py-2 text-sm font-semibold shadow-sm">Yes, Erase Everything</button>
                    <button class="close-modal-btn btn-secondary w-full rounded-md px-3 py-2 text-sm font-semibold shadow-sm">Cancel</button>
                </div>
            </div>`;
        openModal(modalHTML);

        document.getElementById('confirm-erase').addEventListener('click', () => {
            localStorage.removeItem('budgetTrackerState');
            location.reload();
        });
    });

    // -------------------------------------------------------------------------
    // BUSINESS LOGIC & FORM ACTIONS
    // -------------------------------------------------------------------------
    
    const updateAssetBalance = (assetId, amount, type, operation = 'add') => {
        const asset = state.assets.find(a => a.id === assetId);
        if (!asset) return;

        let value = (type === 'income' ? amount : -amount);
        if(operation === 'subtract') value = -value;

        asset.balance += value;
    };
    
    const handleTypeChange = (type) => {
        state.ui.activeType = type;
        renderForm();
    };

    const resetForm = () => {
        state.ui.formMode = 'add';
        state.ui.editingId = null;
        form.reset();
        formIdInput.value = '';
        formDateInput.value = formatDateForInput(new Date());
        cancelEditBtn.classList.add('hidden');
        form.querySelector('button[type="submit"]').textContent = 'Save Transaction';
        handleTypeChange('expense');
    };

    const startEditing = (id) => {
        const transaction = state.transactions.find(t => t.id === id);
        if (!transaction) return;
        
        if (state.ui.currentPage !== 'tracker') {
            state.ui.currentPage = 'tracker';
            renderPage();
        }

        state.ui.formMode = 'edit';
        state.ui.editingId = id;
        
        formIdInput.value = transaction.id;
        handleTypeChange(transaction.type);
        formDateInput.value = formatDateForInput(transaction.date);
        formAssetSelect.value = transaction.assetId;
        formCategorySelect.value = transaction.category;
        formAmountInput.value = transaction.amount;
        formDescriptionInput.value = transaction.description;
        formNoteTextarea.value = transaction.note || '';

        cancelEditBtn.classList.remove('hidden');
        form.querySelector('button[type="submit"]').textContent = 'Update Transaction';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    const deleteTransaction = (id) => {
        const transactionIndex = state.transactions.findIndex(t => t.id === id);
        if (transactionIndex === -1) return;
        
        const transaction = state.transactions[transactionIndex];
        updateAssetBalance(transaction.assetId, transaction.amount, transaction.type, 'subtract');

        state.transactions.splice(transactionIndex, 1);
        saveState();
        render();
        if (state.ui.currentPage === 'all-transactions') renderAllTransactionsPage();
        if (state.ui.currentPage === 'assets') renderAssetsPage();
        if (state.ui.currentPage === 'analytics') renderAnalytics();
    };

    // -------------------------------------------------------------------------
    // EVENT HANDLERS
    // -------------------------------------------------------------------------
    
    form.addEventListener('submit', (e) => {
        e.preventDefault();
        const id = formIdInput.value;
        const amount = parseFloat(formAmountInput.value);
        const type = formTypeInput.value;
        const assetId = formAssetSelect.value;
        
        const transactionData = {
            date: formDateInput.value,
            category: formCategorySelect.value,
            description: formDescriptionInput.value.trim(),
            note: formNoteTextarea.value.trim(),
            amount,
            type,
            assetId,
        };
        if (!transactionData.date || !transactionData.amount || !transactionData.description || !assetId) { return; }
        
        if (state.ui.formMode === 'edit') {
            const index = state.transactions.findIndex(t => t.id === id);
            if (index !== -1) { 
                const oldTransaction = state.transactions[index];
                // Revert old transaction from its asset
                updateAssetBalance(oldTransaction.assetId, oldTransaction.amount, oldTransaction.type, 'subtract');
                // Apply new transaction to its asset
                updateAssetBalance(assetId, amount, type, 'add');
                state.transactions[index] = { ...oldTransaction, ...transactionData };
            }
        } else {
            transactionData.id = crypto.randomUUID();
            transactionData.createdAt = new Date().toISOString();
            updateAssetBalance(assetId, amount, type, 'add');
            state.transactions.push(transactionData);
        }
        resetForm();
        saveState();
        render();
        if (state.ui.currentPage === 'analytics') renderAnalytics();
    });
    
    typeBtnIncome.addEventListener('click', () => handleTypeChange('income'));
    typeBtnExpense.addEventListener('click', () => handleTypeChange('expense'));
    
    visibilityToggleBtn.addEventListener('click', () => {
        state.ui.isBalanceVisible = !state.ui.isBalanceVisible;
        saveState();
        render();
        if (state.ui.currentPage === 'all-transactions') {
            renderAllTransactionsPage();
        }
        if (state.ui.currentPage === 'analytics') {
            renderAnalytics();
        }
    });
    
    // Combined event listener for all transaction lists
    [transactionListContainer, fullTransactionListContainer].forEach(container => {
        container.addEventListener('click', (e) => {
            const editBtn = e.target.closest('.edit-btn');
            if (editBtn) {
                startEditing(editBtn.dataset.id);
            }

            const deleteBtn = e.target.closest('.delete-btn');
            if (deleteBtn) {
                 const idToDelete = deleteBtn.dataset.id;
                 const transaction = state.transactions.find(t => t.id === idToDelete);
                 const modalHTML = `
                    <div class="text-center">
                        <h3 class="mt-2 text-lg font-semibold text-gray-900">Delete Transaction?</h3>
                        <p class="mt-2 text-sm text-gray-500">Are you sure you want to delete this transaction: <br><strong>${transaction.description} (${formatCurrency(transaction.amount)})</strong>?</p>
                        <div class="mt-5 sm:mt-6 flex justify-center space-x-3">
                            <button id="confirm-delete" class="btn-danger w-full rounded-md px-3 py-2 text-sm font-semibold shadow-sm">Yes, Delete</button>
                            <button class="close-modal-btn btn-secondary w-full rounded-md px-3 py-2 text-sm font-semibold shadow-sm">Cancel</button>
                        </div>
                    </div>`;
                openModal(modalHTML);
                document.getElementById('confirm-delete').addEventListener('click', () => {
                    deleteTransaction(idToDelete);
                    closeModal();
                });
            }
            
            const noteToggleBtn = e.target.closest('.note-toggle-btn');
            if(noteToggleBtn) {
                const noteContent = noteToggleBtn.closest('.transaction-item').querySelector('.note-content');
                if (noteContent) {
                    noteToggleBtn.classList.toggle('rotated');
                    noteContent.classList.toggle('visible');
                }
            }
        });
    });

    cancelEditBtn.addEventListener('click', resetForm);

    navTracker.addEventListener('click', () => { state.ui.currentPage = 'tracker'; renderPage(); });
    navAssets.addEventListener('click', () => { state.ui.currentPage = 'assets'; renderPage(); });
    navAllTransactions.addEventListener('click', () => { state.ui.currentPage = 'all-transactions'; renderPage(); });
    navAnalytics.addEventListener('click', () => { state.ui.currentPage = 'analytics'; renderPage(); });

    // -------------------------------------------------------------------------
    // MODALS (Categories & Data Options)
    // -------------------------------------------------------------------------

    const openModal = (content) => {
        modalContent.innerHTML = content;
        modalContainer.classList.remove('hidden');
    };

    const closeModal = () => {
        modalContainer.classList.add('hidden');
        modalContent.innerHTML = '';
    };

    modalContainer.addEventListener('click', (e) => {
        if (e.target === modalContainer || e.target.closest('.close-modal-btn')) {
            closeModal();
        }
    });

    manageCategoriesBtn.addEventListener('click', () => {
        const renderColorPalette = (selectedColor) => {
            return PREDEFINED_COLORS.map(color => `
                <div class="color-swatch ${color === selectedColor ? 'selected' : ''}" style="background-color: ${color};" data-color="${color}"></div>
            `).join('');
        };
        
        const renderCategoryList = (type) => {
            const categories = type === 'income' ? state.incomeCategories.map(name => ({name})) : state.expenseCategories;
            return categories.map(cat => `
                <li class="category-item flex justify-between items-center p-2 bg-slate-100 rounded hover:bg-slate-200" data-name="${cat.name}" data-type="${type}">
                    <span class="category-name flex items-center">
                        ${cat.color ? `<span class="inline-block w-4 h-4 rounded-full mr-2" style="background-color: ${cat.color};"></span>` : ''}
                        ${cat.name}
                    </span>
                    <div class="category-actions flex items-center space-x-2">
                        <button class="rename-category-btn text-slate-400 hover:text-indigo-600 p-1 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                        </button>
                        <button class="delete-category-btn text-slate-400 hover:text-red-600 p-1 rounded-full text-lg font-bold leading-none">&times;</button>
                    </div>
                </li>
            `).join('');
        };

        const modalHTML = `
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Manage Categories</h2>
                <button class="close-modal-btn p-1 text-2xl leading-none">&times;</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="font-semibold mb-2">Income Categories</h3>
                    <ul id="income-cat-list" class="space-y-2 mb-2">${renderCategoryList('income')}</ul>
                    <form id="add-income-cat-form" class="flex gap-2">
                        <input type="text" placeholder="New income category" class="flex-grow block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                        <button type="submit" class="btn-primary px-3 py-1 rounded-md text-sm font-bold">+</button>
                    </form>
                </div>
                <div>
                    <h3 class="font-semibold mb-2">Expense Categories</h3>
                    <ul id="expense-cat-list" class="space-y-2 mb-2">${renderCategoryList('expense')}</ul>
                    <form id="add-expense-cat-form" class="space-y-2">
                         <div class="flex gap-2">
                             <input type="text" name="name" placeholder="New expense category" class="flex-grow block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" required>
                             <button type="submit" class="btn-primary px-3 py-1 rounded-md text-sm font-bold">+</button>
                        </div>
                        <div class="flex flex-wrap gap-2 color-palette">
                            ${renderColorPalette(getRandomColor())}
                        </div>
                        <input type="hidden" name="color" value="${getRandomColor()}">
                    </form>
                </div>
            </div>`;
        openModal(modalHTML);
        
    });

    dataOptionsBtn.addEventListener('click', () => {
        const modalHTML = `
             <div class="flex justify-between items-center mb-4">
                 <h2 class="text-xl font-semibold">Data Options</h2>
                 <button class="close-modal-btn text-2xl">&times;</button>
             </div>
             <div class="space-y-4">
                 <div>
                     <h3 class="font-semibold mb-2">Export Data</h3>
                     <div class="flex space-x-2">
                         <button id="export-json-btn" class="w-full btn-secondary py-2 px-4 rounded-md text-sm">Export as JSON</button>
                         <button id="export-csv-btn" class="w-full btn-secondary py-2 px-4 rounded-md text-sm">Export as CSV</button>
                     </div>
                 </div>
                  <div>
                     <h3 class="font-semibold mb-2">Import Data</h3>
                     <p class="text-sm text-slate-500 mb-1">Import a JSON file. This will overwrite current data.</p>
                     <div class="flex gap-2">
                         <input type="file" id="import-json-input" accept=".json" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/>
                         <button id="submit-json-import" class="btn-primary px-3 py-1 rounded-md text-sm">Import</button>
                     </div>
                     <p id="json-error" class="text-red-500 text-sm mt-1"></p>

                     <p class="text-sm text-slate-500 mb-1 mt-4">Import a CSV file. This will add to current data.</p>
                     <div class="flex gap-2">
                         <input type="file" id="import-csv-input" accept=".csv" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/>
                         <button id="submit-csv-import" class="btn-primary px-3 py-1 rounded-md text-sm">Import</button>
                     </div>
                     <p id="csv-error" class="text-red-500 text-sm mt-1"></p>
                 </div>
             </div>`;
        openModal(modalHTML);
    });

    modalContent.addEventListener('submit', (e) => {
        e.preventDefault();
        if (e.target.id === 'add-income-cat-form') {
            const input = e.target.querySelector('input[type="text"]');
            const newCategory = input.value.trim();
            if (newCategory) state.incomeCategories.push(newCategory);
        } else if (e.target.id === 'add-expense-cat-form') {
            const nameInput = e.target.querySelector('input[name="name"]');
            const colorInput = e.target.querySelector('input[name="color"]');
            const newCategory = { name: nameInput.value.trim(), color: colorInput.value };
            if (newCategory.name) state.expenseCategories.push(newCategory);
        } else if (e.target.id === 'add-asset-form') {
             const nameInput = e.target.querySelector('input[name="name"]');
             const balanceInput = e.target.querySelector('input[name="balance"]');
             if(nameInput.value.trim()){
                 const newAsset = {
                     id: crypto.randomUUID(),
                     name: nameInput.value.trim(),
                     balance: parseFloat(balanceInput.value) || 0
                 };
                 state.assets.push(newAsset);
             }
        }
        saveState();
        if (state.ui.currentPage === 'assets') manageAssetsBtn.click();
        else manageCategoriesBtn.click();
        render();
    });

    modalContent.addEventListener('click', (e) => {
        
        // Delegated listener for color swatches
        const swatch = e.target.closest('.color-swatch');
        if (swatch) {
            const palette = swatch.closest('.color-palette');
            if (!palette) return;

            // Update the visual selection
            palette.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected'));
            swatch.classList.add('selected');

            // Find the parent form/container to update the correct hidden input
            const addForm = swatch.closest('#add-expense-cat-form');
            const editContainer = swatch.closest('.edit-category-container');

            if (addForm) {
                addForm.querySelector('input[name="color"]').value = swatch.dataset.color;
            } else if (editContainer) {
                editContainer.querySelector('input[name="color"]').value = swatch.dataset.color;
            }
        }

        const deleteBtn = e.target.closest('.delete-category-btn');
        if (deleteBtn) {
            const listItem = deleteBtn.closest('.category-item');
            const name = listItem.dataset.name;
            const type = listItem.dataset.type;
            
            const modalHTML = `
                <div class="text-center">
                    <h3 class="mt-2 text-lg font-semibold text-gray-900">Delete Category?</h3>
                    <p class="mt-2 text-sm text-gray-500">Are you sure you want to delete the category "${name}"? This cannot be undone.</p>
                    <div class="mt-5 sm:mt-6 flex justify-center space-x-3">
                        <button id="confirm-cat-delete" class="btn-danger w-full rounded-md px-3 py-2 text-sm font-semibold shadow-sm">Yes, Delete</button>
                        <button class="close-modal-btn btn-secondary w-full rounded-md px-3 py-2 text-sm font-semibold shadow-sm">Cancel</button>
                    </div>
                </div>`;
            openModal(modalHTML);
            
            document.getElementById('confirm-cat-delete').addEventListener('click', () => {
                if (type === 'income') {
                    state.incomeCategories = state.incomeCategories.filter(c => c !== name);
                } else {
                    state.expenseCategories = state.expenseCategories.filter(c => c.name !== name);
                }
                saveState();
                manageCategoriesBtn.click(); // Re-opens and re-renders the manage categories modal
                renderForm();
            });
        }

        const renameBtn = e.target.closest('.rename-category-btn');
        if (renameBtn) {
            const listItem = renameBtn.closest('.category-item');
            const categoryNameSpan = listItem.querySelector('.category-name');
            const categoryActions = listItem.querySelector('.category-actions');
            const oldName = listItem.dataset.name;
            const type = listItem.dataset.type;
            const category = type === 'expense' ? state.expenseCategories.find(c => c.name === oldName) : { name: oldName };

            categoryNameSpan.classList.add('hidden');
            categoryActions.classList.add('hidden');

            const editContainer = document.createElement('div');
            editContainer.className = 'edit-category-container flex-grow space-y-2';
            let colorPaletteHTML = '';
            if(type === 'expense') {
                const renderColorPalette = (selectedColor) => PREDEFINED_COLORS.map(color => `<div class="color-swatch ${color === selectedColor ? 'selected' : ''}" style="background-color: ${color};" data-color="${color}"></div>`).join('');
                colorPaletteHTML = `<div class="flex flex-wrap gap-2 color-palette">${renderColorPalette(category.color)}</div><input type="hidden" name="color" value="${category.color}">`;
            }
            editContainer.innerHTML = `
                <div class="flex items-center gap-2">
                    <input type="text" class="flex-grow block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" value="${oldName}">
                    <button class="save-rename-btn btn-primary px-3 py-1 rounded-md text-sm">Save</button>
                    <button class="cancel-rename-btn btn-secondary px-3 py-1 rounded-md text-sm">X</button>
                </div>
                ${colorPaletteHTML}
            `;
            
            listItem.prepend(editContainer);
            editContainer.querySelector('input').focus();
        }
        
        const saveRenameBtn = e.target.closest('.save-rename-btn');
        if (saveRenameBtn) {
            const listItem = saveRenameBtn.closest('.category-item');
            const input = listItem.querySelector('input[type="text"]');
            const newName = input.value.trim();
            const oldName = listItem.dataset.name;
            const type = listItem.dataset.type;

            let hasChanged = false;
            let nameHasChanged = newName && newName !== oldName;

            if (type === 'income') {
                if (nameHasChanged) {
                    const index = state.incomeCategories.indexOf(oldName);
                    if (index > -1) {
                        state.incomeCategories[index] = newName;
                        hasChanged = true;
                    }
                }
            } else { // type is 'expense'
                const colorInput = listItem.querySelector('input[name="color"]');
                const newColor = colorInput ? colorInput.value : null;
                const category = state.expenseCategories.find(c => c.name === oldName);
                
                if (category) {
                    const colorHasChanged = newColor && newColor !== category.color;
                    if (nameHasChanged) {
                        category.name = newName;
                        hasChanged = true;
                    }
                    if (colorHasChanged) {
                        category.color = newColor;
                        hasChanged = true;
                    }
                }
            }
            
            if (hasChanged) {
                // If name changed, update all transactions with that category
                if (nameHasChanged) {
                    state.transactions.forEach(t => { 
                        if (t.category === oldName) {
                            t.category = newName;
                        }
                    });
                }
                saveState();
                render(); // Full re-render to update UI everywhere
            }
            manageCategoriesBtn.click(); // Re-render the modal to show the updated list or cancel edit view
        }
    
        const cancelRenameBtn = e.target.closest('.cancel-rename-btn');
        if (cancelRenameBtn) {
            manageCategoriesBtn.click(); 
        }

        if (e.target.id === 'export-json-btn') exportToJSON();
        if (e.target.id === 'export-csv-btn') exportToCSV();

        if (e.target.id === 'submit-json-import') {
            const fileInput = modalContent.querySelector('#import-json-input');
            const errorEl = modalContent.querySelector('#json-error');
            errorEl.textContent = ''; // Clear previous errors
            if (fileInput.files.length > 0) {
                importFromJSON(fileInput.files[0]);
            } else {
                errorEl.textContent = 'Please select a JSON file first.';
            }
        }

        if (e.target.id === 'submit-csv-import') {
            const fileInput = modalContent.querySelector('#import-csv-input');
            const errorEl = modalContent.querySelector('#csv-error');
            errorEl.textContent = ''; // Clear previous errors
            if (fileInput.files.length > 0) {
                importFromCSV(fileInput.files[0]);
            } else {
                errorEl.textContent = 'Please select a CSV file first.';
            }
        }
    });
    
    // -------------------------------------------------------------------------
    // DATA IMPORT/EXPORT
    // -------------------------------------------------------------------------

    const exportToJSON = () => {
        const dataStr = JSON.stringify(state, null, 2);
        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', `budget_tracker_data_${new Date().toISOString().split('T')[0]}.json`);
        linkElement.click();
        closeModal();
    };
    
    const exportToCSV = () => {
        const headers = 'ID,Date,Type,Category,Description,Amount,Note,AssetID';
        const rows = state.transactions.map(t => {
            const description = `"${(t.description || '').replace(/"/g, '""')}"`;
            const note = `"${(t.note || '').replace(/"/g, '""')}"`;
            return [t.id, t.date, t.type, t.category, description, t.amount, note, t.assetId].join(',');
        }).join('\n');

        const csvContent = `${headers}\n${rows}`;
        const dataUri = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csvContent);
        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', `budget_transactions_${new Date().toISOString().split('T')[0]}.csv`);
        linkElement.click();
        closeModal();
    };

    const importFromJSON = (file) => {
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const importedState = JSON.parse(e.target.result);
                if (importedState.transactions && importedState.incomeCategories && importedState.expenseCategories) {
                     const modalHTML = `
                        <div class="text-center">
                            <h3 class="mt-2 text-lg font-semibold text-gray-900">Confirm Import</h3>
                            <p class="mt-2 text-sm text-gray-500">Importing this file will overwrite all current data. Are you sure?</p>
                            <div class="mt-5 sm:mt-6 flex justify-center space-x-3">
                                <button id="confirm-import-json" class="btn-primary w-full rounded-md px-3 py-2 text-sm font-semibold shadow-sm">Yes, Import and Overwrite</button>
                                <button class="close-modal-btn btn-secondary w-full rounded-md px-3 py-2 text-sm font-semibold shadow-sm">Cancel</button>
                            </div>
                        </div>`;
                    openModal(modalHTML);
                    document.getElementById('confirm-import-json').addEventListener('click', () => {
                        state = importedState;
                        saveState();
                        render();
                        closeModal();
                    });
                } else { 
                    modalContent.querySelector('#json-error').textContent = 'Invalid file format.';
                 }
            } catch (error) { 
                modalContent.querySelector('#json-error').textContent = 'Error reading file.';
            }
        };
        reader.readAsText(file);
    };
    
    const importFromCSV = (file) => {
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const csv = e.target.result;
                const lines = csv.split('\n').filter(line => line.trim());
                if (lines.length <= 1) {
                    modalContent.querySelector('#csv-error').textContent = 'CSV file is empty or has no data rows.';
                    return;
                }
                const header = lines[0].trim().split(',');
                const expectedHeader = ['ID','Date','Type','Category','Description','Amount','Note', 'AssetID'];

                if(JSON.stringify(header) !== JSON.stringify(expectedHeader)) {
                    modalContent.querySelector('#csv-error').textContent = 'Invalid CSV header.';
                    return;
                }
                
                const newTransactions = lines.slice(1).map(line => {
                    const columns = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g).map(field => field.replace(/"/g, ''));
                    const transaction = {
                        id: columns[0] || crypto.randomUUID(),
                        date: columns[1],
                        type: columns[2].toLowerCase(),
                        category: columns[3],
                        description: columns[4],
                        amount: parseFloat(columns[5]),
                        note: columns[6] || '',
                        assetId: columns[7]
                    };

                    // Find or create asset
                    let asset = state.assets.find(a => a.id === transaction.assetId);
                    if (!asset) {
                       transaction.assetId = state.assets[0]?.id || 'cash-default'; // Fallback to first asset
                    }
                    
                    // Update asset balance based on this imported transaction
                    updateAssetBalance(transaction.assetId, transaction.amount, transaction.type, 'add');

                    return transaction;
                });
                
                const modalHTML = `
                    <div class="text-center">
                        <h3 class="mt-2 text-lg font-semibold text-gray-900">Confirm Import</h3>
                        <p class="mt-2 text-sm text-gray-500">Found ${newTransactions.length} transactions. Add them to your current data?</p>
                        <div class="mt-5 sm:mt-6 flex justify-center space-x-3">
                            <button id="confirm-import-csv" class="btn-primary w-full rounded-md px-3 py-2 text-sm font-semibold shadow-sm">Yes, Add Transactions</button>
                            <button class="close-modal-btn btn-secondary w-full rounded-md px-3 py-2 text-sm font-semibold shadow-sm">Cancel</button>
                        </div>
                    </div>`;
                openModal(modalHTML);
                document.getElementById('confirm-import-csv').addEventListener('click', () => {
                    newTransactions.forEach(t => {
                        if (t.type === 'income' && !state.incomeCategories.includes(t.category)) {
                            state.incomeCategories.push(t.category);
                        } else if (t.type === 'expense' && !state.expenseCategories.find(c => c.name === t.category)) {
                            state.expenseCategories.push({ name: t.category, color: getRandomColor() });
                        }
                    });

                    state.transactions.push(...newTransactions);
                    saveState();
                    render();
                    closeModal();
                });
            } catch (error) {
                console.error("Error importing CSV:", error);
                modalContent.querySelector('#csv-error').textContent = 'Error parsing CSV file.';
            }
        };
        reader.readAsText(file);
    };


    // -------------------------------------------------------------------------
    // ANALYTICS & CHARTING (using Chart.js)
    // -------------------------------------------------------------------------

    let expensePieChart, expenseTrendChart, assetPieChart;

    const destroyCharts = () => {
        if (expensePieChart) expensePieChart.destroy();
        if (expenseTrendChart) expenseTrendChart.destroy();
        if (assetPieChart) assetPieChart.destroy();
        expensePieChart = null;
        expenseTrendChart = null;
        assetPieChart = null;
    };

    const renderAnalytics = () => {
        if (state.ui.currentPage !== 'analytics') return;
        destroyCharts();
        populateAnalyticsFilters();
        const filtered = getFilteredTransactions();

        const isVisible = state.ui.isBalanceVisible;
        const censoredText = '₹ ******';

        const income = filtered.filter(t => t.type === 'income' && t.category !== 'Internal Transfer').reduce((s, t) => s + t.amount, 0);
        const expense = filtered.filter(t => t.type === 'expense' && t.category !== 'Internal Transfer').reduce((s, t) => s + t.amount, 0);
        const savings = income - expense;

        analyticsSavingsEl.textContent = isVisible ? formatCurrency(savings) : censoredText;
        analyticsIncomeEl.textContent = isVisible ? formatCurrency(income) : censoredText;
        analyticsExpensesEl.textContent = isVisible ? formatCurrency(expense) : censoredText;

        analyticsSavingsEl.className = `text-3xl font-bold ${savings >= 0 ? 'text-purple-600' : 'text-orange-500'}`;
        analyticsIncomeEl.className = 'text-3xl font-bold text-green-600';
        analyticsExpensesEl.className = 'text-3xl font-bold text-red-600';
        
        const chartTransactions = filtered.filter(t => t.category !== 'Internal Transfer');
        renderExpensePieChart(chartTransactions);
        renderExpenseTrendChart(chartTransactions);
    };
    
    const populateAnalyticsFilters = () => {
        const years = [...new Set(state.transactions.map(t => new Date(t.date).getFullYear()))];
        if (!years.includes(new Date().getFullYear())) { years.push(new Date().getFullYear()); }
        analyticsYearSelect.innerHTML = years.sort((a,b) => b-a).map(y => `<option value="${y}" ${y === state.ui.analytics.year ? 'selected' : ''}>${y}</option>`).join('');
        const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
        analyticsMonthSelect.innerHTML = months.map((m, i) => `<option value="${i}" ${i === state.ui.analytics.month ? 'selected' : ''}>${m}</option>`).join('');
    };

    [analyticsPeriodSelect, analyticsYearSelect, analyticsMonthSelect].forEach(el => {
        el.addEventListener('change', () => {
            state.ui.analytics.period = analyticsPeriodSelect.value;
            state.ui.analytics.year = parseInt(analyticsYearSelect.value);
            state.ui.analytics.month = parseInt(analyticsMonthSelect.value);
            analyticsYearSelect.disabled = !['this-month', 'this-year'].includes(state.ui.analytics.period);
            analyticsMonthSelect.disabled = state.ui.analytics.period !== 'this-month';
            renderAnalytics();
        });
    });

    const getFilteredTransactions = () => {
        const now = new Date();
        const { period, year, month } = state.ui.analytics;
        let start, end;
        switch (period) {
            case 'this-week':
                start = new Date(now.setDate(now.getDate() - now.getDay()));
                end = new Date(new Date(start).setDate(start.getDate() + 7));
                break;
            case 'this-month':
                start = new Date(year, month, 1);
                end = new Date(year, month + 1, 1);
                break;
            case 'this-year':
                start = new Date(year, 0, 1);
                end = new Date(year + 1, 0, 1);
                break;
            case 'ytd':
                start = new Date(now.getFullYear(), 0, 1);
                end = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
                break;
            case 'all-time': return state.transactions;
            default: return [];
        }
        return state.transactions.filter(t => {
            const d = new Date(t.date);
            const adjD = new Date(d.valueOf() + d.getTimezoneOffset() * 60000);
            return adjD >= start && adjD < end;
        });
    };
    
    const renderExpensePieChart = (transactions) => {
        const emptyMsg = document.getElementById('expense-chart-empty');
        const ctx = document.getElementById('expense-chart').getContext('2d');
        const expenses = transactions.filter(t => t.type === 'expense');

        if (expenses.length === 0) {
            emptyMsg.classList.remove('hidden');
            return;
        }
        emptyMsg.classList.add('hidden');

        const byCat = expenses.reduce((a, t) => {
            a[t.category] = (a[t.category] || 0) + t.amount;
            return a;
        }, {});

        const labels = Object.keys(byCat);
        const data = Object.values(byCat);
        const backgroundColors = labels.map(label => state.expenseCategories.find(c => c.name === label)?.color || getRandomColor());

        expensePieChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: backgroundColors,
                    borderColor: '#fff',
                    borderWidth: 2,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        onClick: (e, legendItem, legend) => {
                            const chart = legend.chart;
                            // 1. Manually replicate default Chart.js v4+ behavior for pie/doughnut charts
                            chart.toggleDataVisibility(legendItem.index);
                            chart.update();
                            
                            // 2. Sync our state with the chart's legend state
                            state.ui.analytics.hiddenCategories = legend.legendItems
                                .filter(item => item.hidden)
                                .map(item => item.text);
                            
                            // 3. Re-render ONLY the trend chart with the updated filter state
                            const filteredTimeTxs = getFilteredTransactions();
                            const chartTxs = filteredTimeTxs.filter(t => t.category !== 'Internal Transfer');
                            renderExpenseTrendChart(chartTxs);
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed !== null) {
                                    label += formatCurrency(context.parsed);
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    };

    const renderExpenseTrendChart = (transactions) => {
        const emptyMsg = document.getElementById('expense-trend-chart-empty');
        const ctx = document.getElementById('expense-trend-chart').getContext('2d');
        
        // Filter out hidden categories from state
        const visibleTransactions = transactions.filter(t => !state.ui.analytics.hiddenCategories.includes(t.category));
        
        const expenses = visibleTransactions.filter(t => t.type === 'expense');

        const grouped = expenses.reduce((a, t) => {
            const key = new Date(t.date).toISOString().split('T')[0];
            a[key] = (a[key] || 0) + t.amount;
            return a;
        }, {});
        
        const labels = Object.keys(grouped).sort();
        
        if (expenseTrendChart) {
            expenseTrendChart.destroy();
            expenseTrendChart = null;
        }

        if (labels.length < 2) {
            emptyMsg.classList.remove('hidden');
            return;
        }
        emptyMsg.classList.add('hidden');

        const data = labels.map(k => grouped[k]);
        
        expenseTrendChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Expense',
                    data: data,
                    borderColor: '#ef4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    fill: true,
                    tension: 0.3,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { callback: value => formatCurrency(value) }
                    },
                    x: {
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                },
                 plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: context => `Expense: ${formatCurrency(context.parsed.y)}`
                        }
                    }
                }
            }
        });
    };
    
    // -------------------------------------------------------------------------
    // ASSETS PAGE LOGIC
    // -------------------------------------------------------------------------
    
    const renderAssetsPage = () => {
        const isVisible = state.ui.isBalanceVisible;
        const censoredText = '₹ ******';

        // Calculate and display Total Assets
        const totalAssets = state.assets.reduce((sum, asset) => sum + asset.balance, 0);
        if (totalAssetsAmountEl) { // Check if element exists
             totalAssetsAmountEl.textContent = isVisible ? formatCurrency(totalAssets) : censoredText;
             totalAssetsAmountEl.className = `text-3xl font-bold ${totalAssets >= 0 ? 'text-blue-600' : 'text-orange-500'}`;
        }

        // Render list of assets
        assetListEl.innerHTML = state.assets.map(asset => `
            <li class="flex justify-between items-center">
                <span class="font-medium">${asset.name}</span>
                <span class="text-slate-600">${state.ui.isBalanceVisible ? formatCurrency(asset.balance) : '******'}</span>
            </li>
        `).join('');

        // Populate transfer form dropdowns
        const transferFromSelect = document.getElementById('transfer-from');
        const transferToSelect = document.getElementById('transfer-to');
        transferFromSelect.innerHTML = state.assets.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
        transferToSelect.innerHTML = state.assets.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
        
        renderAssetPieChart();
    };

    transferForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const fromId = document.getElementById('transfer-from').value;
        const toId = document.getElementById('transfer-to').value;
        const amount = parseFloat(document.getElementById('transfer-amount').value);

        if(!amount || amount <= 0 || fromId === toId) {
             const modalHTML = `
                <div class="text-center">
                    <h3 class="mt-2 text-lg font-semibold text-gray-900">Invalid Transfer</h3>
                    <p class="mt-2 text-sm text-gray-500">Please check the amount and ensure the 'From' and 'To' accounts are different.</p>
                    <div class="mt-5 sm:mt-6">
                        <button class="close-modal-btn btn-primary w-full rounded-md px-3 py-2 text-sm font-semibold shadow-sm">OK</button>
                    </div>
                </div>`;
            openModal(modalHTML);
            return;
        }

        // Create two transactions to log the transfer
        const date = new Date().toISOString().split('T')[0];
        const fromAsset = state.assets.find(a=>a.id === fromId);
        const toAsset = state.assets.find(a=>a.id === toId);

        if (!fromAsset || !toAsset) {
            // Handle case where asset is not found, although it shouldn't happen with the dropdowns.
             const modalHTML = `
                <div class="text-center">
                    <h3 class="mt-2 text-lg font-semibold text-gray-900">Error</h3>
                    <p class="mt-2 text-sm text-gray-500">Could not find the selected accounts.</p>
                    <div class="mt-5 sm:mt-6">
                        <button class="close-modal-btn btn-primary w-full rounded-md px-3 py-2 text-sm font-semibold shadow-sm">OK</button>
                    </div>
                </div>`;
            openModal(modalHTML);
            return;
        }

        // Expense from source asset
        state.transactions.push({
            id: crypto.randomUUID(),
            createdAt: new Date().toISOString(),
            date: date,
            type: 'expense',
            category: 'Internal Transfer',
            description: `Transfer to ${toAsset.name}`,
            amount: amount,
            assetId: fromId,
            note: ''
        });
        updateAssetBalance(fromId, amount, 'expense');

        // Income to destination asset
        state.transactions.push({
            id: crypto.randomUUID(),
            createdAt: new Date().toISOString(),
            date: date,
            type: 'income',
            category: 'Internal Transfer',
            description: `Transfer from ${fromAsset.name}`,
            amount: amount,
            assetId: toId,
            note: ''
        });
        updateAssetBalance(toId, amount, 'income');

        saveState();
        render(); // Full re-render
        renderAssetsPage();
        transferForm.reset();
    });

    const renderAssetPieChart = () => {
        if(assetPieChart) assetPieChart.destroy();
        const emptyMsg = document.getElementById('asset-chart-empty');
        const ctx = document.getElementById('asset-chart').getContext('2d');
        
        if(state.assets.length === 0 || state.assets.every(a => a.balance <= 0)) {
            emptyMsg.classList.remove('hidden');
            return;
        }
        emptyMsg.classList.add('hidden');

        const labels = state.assets.map(a => a.name);
        const data = state.assets.map(a => a.balance);
        const backgroundColors = state.assets.map((_, index) => PREDEFINED_COLORS[index % PREDEFINED_COLORS.length]);

        assetPieChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: backgroundColors,
                    borderColor: '#fff',
                    borderWidth: 2,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: {
                        callbacks: {
                            label: context => `${context.label}: ${formatCurrency(context.parsed)}`
                        }
                    }
                }
            }
        });
    };

    manageAssetsBtn.addEventListener('click', () => {
        const modalHTML = `
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Manage Assets</h2>
                <button class="close-modal-btn p-1 text-2xl leading-none">&times;</button>
            </div>
            <div>
                <h3 class="font-semibold mb-2">Your Accounts</h3>
                <ul id="manage-asset-list" class="space-y-2 mb-4">
                    ${state.assets.map(asset => `
                        <li class="asset-item flex justify-between items-center p-2 bg-slate-100 rounded" data-id="${asset.id}" data-name="${asset.name}">
                             <span class="asset-name">${asset.name}</span>
                             <div class="asset-actions flex items-center space-x-2">
                                 <button class="rename-asset-btn text-slate-400 hover:text-indigo-600 p-1 rounded-full">
                                     <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                                 </button>
                                 <button class="delete-asset-btn text-slate-400 hover:text-red-600 p-1 rounded-full text-lg font-bold leading-none">&times;</button>
                             </div>
                        </li>
                    `).join('')}
                </ul>
                <h3 class="font-semibold mb-2 mt-6">Add New Asset</h3>
                <form id="add-asset-form" class="flex gap-2">
                    <input type="text" name="name" placeholder="Asset Name" class="flex-grow block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" required>
                    <input type="number" name="balance" placeholder="Initial Balance" class="block w-32 rounded-md border-gray-300 shadow-sm sm:text-sm" step="0.01">
                    <button type="submit" class="btn-primary px-3 py-1 rounded-md text-sm font-bold">+</button>
                </form>
            </div>`;
        openModal(modalHTML);
    });

     modalContent.addEventListener('click', (e) => {
        const deleteBtn = e.target.closest('.delete-asset-btn');
        if(deleteBtn) {
            const listItem = deleteBtn.closest('.asset-item');
            const assetId = listItem.dataset.id;
            const assetName = listItem.dataset.name;
            const transactionCount = state.transactions.filter(t => t.assetId === assetId).length;

            if (transactionCount > 0) {
                 const modalHTML = `
                    <div class="text-center">
                        <h3 class="mt-2 text-lg font-semibold text-gray-900">Cannot Delete Asset</h3>
                        <p class="mt-2 text-sm text-gray-500">Cannot delete "${assetName}" because it has ${transactionCount} transactions linked to it. Please reassign or delete them first.</p>
                        <div class="mt-5 sm:mt-6">
                            <button class="close-modal-btn btn-primary w-full rounded-md px-3 py-2 text-sm font-semibold shadow-sm">OK</button>
                        </div>
                    </div>`;
                openModal(modalHTML);
                return;
            }
             const modalHTML = `
                <div class="text-center">
                    <h3 class="mt-2 text-lg font-semibold text-gray-900">Delete Asset?</h3>
                    <p class="mt-2 text-sm text-gray-500">Are you sure you want to delete the asset "${assetName}"?</p>
                    <div class="mt-5 sm:mt-6 flex justify-center space-x-3">
                        <button id="confirm-asset-delete" class="btn-danger w-full rounded-md px-3 py-2 text-sm font-semibold shadow-sm">Yes, Delete</button>
                        <button class="close-modal-btn btn-secondary w-full rounded-md px-3 py-2 text-sm font-semibold shadow-sm">Cancel</button>
                    </div>
                </div>`;
            openModal(modalHTML);

            document.getElementById('confirm-asset-delete').addEventListener('click', () => {
                state.assets = state.assets.filter(a => a.id !== assetId);
                saveState();
                render();
                manageAssetsBtn.click();
            });
        }

        const renameBtn = e.target.closest('.rename-asset-btn');
        if(renameBtn) {
             const listItem = renameBtn.closest('.asset-item');
             const assetNameSpan = listItem.querySelector('.asset-name');
             const assetActions = listItem.querySelector('.asset-actions');
             const oldName = listItem.dataset.name;
             const assetId = listItem.dataset.id;
             const asset = state.assets.find(a => a.id === assetId);
             if (!asset) return;

             assetNameSpan.classList.add('hidden');
             assetActions.classList.add('hidden');
             const editContainer = document.createElement('div');
             editContainer.className = 'flex-grow grid grid-cols-1 md:grid-cols-2 gap-2 items-center';
             editContainer.innerHTML = `
                <input type="text" class="asset-name-input block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" value="${oldName}">
                <div class="relative">
                     <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3"><span class="text-gray-500 sm:text-sm">₹</span></div>
                     <input type="number" step="0.01" class="asset-balance-input block w-full rounded-md border-gray-300 shadow-sm sm:text-sm pl-7" value="${asset.balance}">
                </div>
                 <div class="md:col-span-2 flex gap-2">
                    <button class="save-rename-asset-btn btn-primary px-3 py-1 rounded-md text-sm w-full">Save</button>
                    <button class="cancel-rename-asset-btn btn-secondary px-3 py-1 rounded-md text-sm w-full">Cancel</button>
                 </div>
            `;
             listItem.prepend(editContainer);
             editContainer.querySelector('input').focus();
        }

        const saveRenameBtn = e.target.closest('.save-rename-asset-btn');
        if(saveRenameBtn) {
            const listItem = saveRenameBtn.closest('.asset-item');
            const nameInput = listItem.querySelector('.asset-name-input');
            const balanceInput = listItem.querySelector('.asset-balance-input');
            const newName = nameInput.value.trim();
            const newBalance = parseFloat(balanceInput.value);
            const assetId = listItem.dataset.id;

            if (newName && !isNaN(newBalance)) {
                const asset = state.assets.find(a => a.id === assetId);
                if (asset) {
                    asset.name = newName;
                    asset.balance = newBalance;
                }
                saveState();
                render();
                manageAssetsBtn.click();
            }
        }

        const cancelRenameAssetBtn = e.target.closest('.cancel-rename-asset-btn');
        if(cancelRenameAssetBtn) {
            manageAssetsBtn.click();
        }
     });

    // -------------------------------------------------------------------------
    // INITIALIZATION
    // -------------------------------------------------------------------------

    const init = () => {
        loadState();
        formDateInput.value = formatDateForInput(new Date());
        render();
        // Resize charts on window resize
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                if (state.ui.currentPage === 'analytics') renderAnalytics();
                if (state.ui.currentPage === 'assets') renderAssetsPage();
            }, 250);
        });
    };

    init();
});
</script>

</body>
</html>




